Index: applications/order/webapp/ordermgr/order/orderpaymentinfo.ftl
===================================================================
--- applications/order/webapp/ordermgr/order/orderpaymentinfo.ftl	(revision 1077839)
+++ applications/order/webapp/ordermgr/order/orderpaymentinfo.ftl	(working copy)
@@ -40,39 +40,6 @@
   </div>
   <div class="screenlet-body">
      <table class="basic-table" cellspacing='0'>
-     <#assign orderTypeId = orderReadHelper.getOrderTypeId()> 
-     <#if orderTypeId == "PURCHASE_ORDER">
-       <tr>
-         <th>${uiLabelMap.AccountingPaymentID}</th>
-         <th>${uiLabelMap.CommonTo}</th>
-         <th>${uiLabelMap.CommonAmount}</th>
-         <th>${uiLabelMap.CommonStatus}</th>
-       </tr>
-       <#list orderPaymentPreferences as orderPaymentPreference>
-         <#assign payments = orderPaymentPreference.getRelated("Payment")>
-         <#list payments as payment>
-           <#assign statusItem = payment.getRelatedOne("StatusItem")>
-           <#assign partyName = delegator.findOne("PartyNameView", {"partyId" : payment.partyIdTo}, true)>
-           <tr>
-             <#if security.hasPermission("PAY_INFO_VIEW", session) || security.hasPermission("PAY_INFO_ADMIN", session)> 
-               <td><a href="/accounting/control/paymentOverview?paymentId=${payment.paymentId}">${payment.paymentId}</a></td>
-             <#else>
-               <td>${payment.paymentId}</td>
-             </#if>
-             <td>${partyName.groupName?if_exists}${partyName.lastName?if_exists} ${partyName.firstName?if_exists} ${partyName.middleName?if_exists}
-             <#if security.hasPermission("PARTYMGR_VIEW", session) || security.hasPermission("PARTYMGR_ADMIN", session)> 
-               [<a href="/partymgr/control/viewprofile?partyId=${partyId}">${partyId}</a>]
-             <#else>
-               [${partyId}]
-             </#if>
-             </td>
-             <td><@ofbizCurrency amount=payment.amount?if_exists/></td>
-             <td>${statusItem.description}</td>
-           </tr>
-         </#list>
-       </#list>
-     <#else>
-     
      <#-- order payment status -->
      <tr>
        <td align="center" valign="top" width="29%" class="label">&nbsp;${uiLabelMap.OrderStatusHistory}</td>
@@ -253,7 +220,7 @@
                       <#if security.hasEntityPermission("PAY_INFO", "_VIEW", session)>
                         ${creditCard.cardType}
                         <@maskSensitiveNumber cardNumber=creditCard.cardNumber?if_exists/>
-                        ${creditCard.expireDate}
+                        ${creditCard.expireDate?if_exists}
                         &nbsp;[<#if oppStatusItem?exists>${oppStatusItem.get("description",locale)}<#else>${orderPaymentPreference.statusId}</#if>]
                       <#else>
                         ${Static["org.ofbiz.party.contact.ContactHelper"].formatCreditCard(creditCard)}
@@ -389,6 +356,50 @@
                   </#if>
                 </td>
               </tr>
+            <#elseif paymentMethod.paymentMethodTypeId?if_exists == "EXT_PAYPAL">
+                <#assign gatewayResponses = orderPaymentPreference.getRelated("PaymentGatewayResponse")>
+                <tr>
+                <td align="right" valign="top" width="29%">
+                  <div>&nbsp;<span class="label">Express PayPal Checkout</span>
+                  <#if orderPaymentPreference.maxAmount?has_content>
+                     <br/>${uiLabelMap.OrderPaymentMaximumAmount}: <@ofbizCurrency amount=orderPaymentPreference.maxAmount?default(0.00) isoCode=currencyUomId/>
+                  </#if>
+                  </div>
+                </td>
+                <td width="1%">&nbsp;</td>
+                <td valign="top" width="60%">${orderPaymentPreference.statusId}
+                    <div>
+                        <#if orderPaymentPreference.statusId != "PAYMENT_SETTLED">
+                          <a href="/accounting/control/AuthorizeTransaction?orderId=${orderId?if_exists}&orderPaymentPreferenceId=${orderPaymentPreference.orderPaymentPreferenceId}&amp;externalLoginKey=${externalLoginKey}" class="buttontext">${uiLabelMap.AccountingAuthorize}</a>
+                        </#if>
+                        <#if orderPaymentPreference.statusId == "PAYMENT_AUTHORIZED">
+                          <a href="/accounting/control/CaptureTransaction?orderId=${orderId?if_exists}&orderPaymentPreferenceId=${orderPaymentPreference.orderPaymentPreferenceId}&amp;externalLoginKey=${externalLoginKey}" class="buttontext">${uiLabelMap.AccountingCapture}</a>
+                        </#if>
+                      </div>
+                    <#if gatewayResponses?has_content>
+                    <div>
+                      <hr/>
+                      <#list gatewayResponses as gatewayResponse>
+                        <#assign transactionCode = gatewayResponse.getRelatedOne("TranCodeEnumeration")>
+                        ${(transactionCode.get("description",locale))?default("Unknown")}:
+                        ${gatewayResponse.transactionDate.toString()}
+                        <@ofbizCurrency amount=gatewayResponse.amount isoCode=currencyUomId/><br/>
+                        (<span class="label">${uiLabelMap.OrderReference}</span>&nbsp;${gatewayResponse.referenceNum?if_exists}
+                        <span class="label">${uiLabelMap.OrderAvs}</span>&nbsp;${gatewayResponse.gatewayAvsResult?default("N/A")}
+                        <span class="label">${uiLabelMap.OrderScore}</span>&nbsp;${gatewayResponse.gatewayScoreResult?default("N/A")})
+                        <a href="/financials/control/ViewGatewayResponse?paymentGatewayResponseId=${gatewayResponse.paymentGatewayResponseId}&amp;externalLoginKey=${externalLoginKey}" class="buttontext">${uiLabelMap.CommonDetails}</a>
+                        <#if gatewayResponse_has_next><hr/></#if>
+                      </#list>
+                    </div>
+                  </#if>
+                <td width="10%">
+                  <#if (!orderHeader.statusId.equals("ORDER_COMPLETED")) && !(orderHeader.statusId.equals("ORDER_REJECTED")) && !(orderHeader.statusId.equals("ORDER_CANCELLED"))>
+                   <#if orderPaymentPreference.statusId != "PAYMENT_SETTLED">                        
+                      <div><a href="<@ofbizUrl>updateOrderPaymentPreference?orderId=${orderId}&amp;orderPaymentPreferenceId=${orderPaymentPreference.orderPaymentPreferenceId}&amp;statusId=PAYMENT_CANCELLED&amp;checkOutPaymentId=${paymentMethod.paymentMethodTypeId?if_exists}</@ofbizUrl>" class="buttontext">${uiLabelMap.CommonCancel}</a></div>
+                   </#if>
+                  </#if>
+                </td>
+              </tr>
             </#if>
           </#if>
           <#if pmBillingAddress?has_content>
@@ -452,7 +463,7 @@
             <td valign="top" width="60%">
               <#list invoices as invoice>
                 <div>${uiLabelMap.CommonNbr}<a href="/accounting/control/invoiceOverview?invoiceId=${invoice}&amp;externalLoginKey=${externalLoginKey}" class="buttontext">${invoice}</a>
-                (<a target="_BLANK" href="/accounting/control/invoice.pdf?invoiceId=${invoice}&amp;externalLoginKey=${externalLoginKey}" class="buttontext">PDF</a>)</div>
+                (<a href="/accounting/control/invoice.pdf?invoiceId=${invoice}&amp;externalLoginKey=${externalLoginKey}" class="buttontext">PDF</a>)</div>
               </#list>
             </td>
             <td width="10%">&nbsp;</td>
@@ -518,7 +529,6 @@
    </form>
    </td></tr>
 </#if>
-</#if>
 </table>
 </div>
-</div>
+</div>
\ No newline at end of file
